{"componentChunkName":"component---src-pages-tech-writings-markdown-remark-frontmatter-slug-jsx","path":"/tech-writings/create-a-postfix-mail-server/","result":{"data":{"markdownRemark":{"html":"<p>In this brief article which features a comprehensive bash script for setting up an SMTP mailserver...</p>\n<h1>The Script</h1>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\r\n<span class=\"token assign-left variable\">DOMAIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"greenpower.monster\"</span>\r\n<span class=\"token assign-left variable\">SMTP_SUBDOMAIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"smtp\"</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"A record for domain is:\"</span>\r\n<span class=\"token function\">dig</span> +short <span class=\"token variable\">${DOMAIN}</span>\r\n\r\nadduser <span class=\"token parameter variable\">--gecos</span> <span class=\"token string\">\"Noreply\"</span> --disabled-password noreply <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"noreply:Kode1234!\"</span> <span class=\"token operator\">|</span> chpasswd\r\n\r\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">DEBIAN_FRONTEND</span><span class=\"token operator\">=</span>noninteractive\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"postfix postfix/main_mailer_type select Internet\"</span> <span class=\"token operator\">|</span> debconf-set-selections\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"postfix postfix/mailname string <span class=\"token variable\">${SMTP_SUBDOMAIN}</span>.<span class=\"token variable\">${DOMAIN}</span>\"</span> <span class=\"token operator\">|</span> debconf-set-selections\r\n\r\n\r\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> <span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt</span> upgrade -y<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Failed to update packages. Exiting.\"</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> postfix dovecot-core dovecot-imapd certbot python3-certbot-nginx ufw <span class=\"token function\">lsof</span> rsyslog mailutils dnsutils\r\n<span class=\"token function\">touch</span> /var/log/mail.log\r\n<span class=\"token function\">touch</span> /var/log/mail.err\r\n<span class=\"token function\">chmod</span> <span class=\"token number\">640</span> /var/log/mail.log\r\n<span class=\"token function\">chmod</span> <span class=\"token number\">640</span> /var/log/mail.err\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Configuring Postfix...\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"myhostname = <span class=\"token variable\">${SMTP_SUBDOMAIN}</span>.<span class=\"token variable\">${DOMAIN}</span>\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"mydomain = <span class=\"token variable\">${DOMAIN}</span>\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"myorigin = <span class=\"token variable\">${DOMAIN}</span>\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"mydestination = localhost, localhost.<span class=\"token variable\">${DOMAIN}</span>, <span class=\"token variable\">${DOMAIN}</span>, <span class=\"token variable\">${SMTP_SUBDOMAIN}</span>.<span class=\"token variable\">${DOMAIN}</span>\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"inet_interfaces = all\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"inet_protocols = ipv4\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"mynetworks = 127.0.0.0/8\"</span>\r\n<span class=\"token comment\"># shellcheck disable=SC2154</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"relay_domains = <span class=\"token variable\">$mydomain</span>\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_tls_protocols = !SSLv2, !SSLv3\"</span>  <span class=\"token comment\"># Disable insecure protocols</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_tls_auth_only = no\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_tls_received_header = yes\"</span>\r\n\r\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/postfix/relay_domains</span>\r\n<span class=\"token variable\">${DOMAIN}</span> OK\r\ngmail.com OK\r\nprotonmail.com OK\r\nEOF</span>\r\n\r\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/postfix/master.cf</span>\r\nsubmission inet n       -       y       -       -       smtpd\r\n  -o syslog_name=postfix/submission\r\n  -o smtpd_tls_security_level=encrypt\r\n  -o smtpd_sasl_auth_enable=yes\r\n  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject\r\nEOF</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Configuring Dovecot... (without SSL paths initially)\"</span>\r\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/dovecot/dovecot.conf</span>\r\nmail_location = maildir:~/Maildir\r\n\r\nprotocols = imap\r\nauth_mechanisms = plain login\r\n\r\nservice imap-login {\r\n   inet_listener imap {\r\n      port = 0  # Disable plain IMAP\r\n   }\r\n   inet_listener imaps {\r\n      port = 993\r\n      ssl = yes\r\n   }\r\n}\r\nservice auth {\r\n   unix_listener /var/spool/postfix/private/auth {\r\n      mode = 0660\r\n      user = postfix\r\n      group = postfix\r\n   }\r\n}\r\n\r\npassdb {\r\n  driver = pam\r\n}\r\n\r\nuserdb {\r\n  driver = passwd\r\n}\r\nEOF</span>\r\n\r\n<span class=\"token keyword\">if</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-i</span> :80<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Port 80 is in use. Stopping the process using it...\"</span>\r\n    <span class=\"token function\">fuser</span> <span class=\"token parameter variable\">-k</span> <span class=\"token number\">80</span>/tcp\r\n<span class=\"token keyword\">fi</span>\r\n\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Obtaining Let's Encrypt certificates using --standalone web server\"</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> certbot certonly <span class=\"token parameter variable\">--standalone</span> --non-interactive --agree-tos <span class=\"token parameter variable\">--email</span> ta.privat@protonmail.com <span class=\"token parameter variable\">-d</span> <span class=\"token variable\">${DOMAIN}</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Failed to obtain Let's Encrypt certificates. Please check the logs.\"</span>\r\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-f</span> /etc/letsencrypt/live/<span class=\"token variable\">${DOMAIN}</span>/fullchain.pem <span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-f</span> /etc/letsencrypt/live/<span class=\"token variable\">${DOMAIN}</span>/privkey.pem <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"SSL certificate files do not exist. Please check the certificate generation step.\"</span>\r\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Updating Dovecot configuration with SSL paths...\"</span> <span class=\"token comment\"># CHEKC THIS!</span>\r\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">>></span> /etc/dovecot/dovecot.conf</span>\r\nssl_cert = &lt;/etc/letsencrypt/live/<span class=\"token variable\">${DOMAIN}</span>/fullchain.pem\r\nssl_key = &lt;/etc/letsencrypt/live/<span class=\"token variable\">${DOMAIN}</span>/privkey.pem\r\nEOF</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Configuring Dovecot for SASL...\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_sasl_type = dovecot\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_sasl_path = private/auth\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_sasl_local_domain = <span class=\"token variable\">${DOMAIN}</span>\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_sasl_auth_enable = yes\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_recipient_restrictions = permit_sasl_authenticated, reject_unauth_destination\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_sender_restrictions = permit_mynetworks, permit_sasl_authenticated, reject\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_tls_cert_file = /etc/letsencrypt/live/<span class=\"token variable\">${DOMAIN}</span>/fullchain.pem\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_tls_key_file = /etc/letsencrypt/live/<span class=\"token variable\">${DOMAIN}</span>/privkey.pem\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"smtpd_use_tls = yes\"</span>\r\npostconf <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"debug_peer_list = localhost\"</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Restarting Dovecot with new SSL configuration...\"</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> systemctl restart dovecot<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Failed to restart Dovecot. Exiting.\"</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Restarting Postfix...\"</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> systemctl restart postfix<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Failed to restart Postfix. Exiting.\"</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Configuring UFW firewall rules...\"</span>\r\nufw allow <span class=\"token number\">25</span>/tcp  <span class=\"token comment\"># SMTP</span>\r\nufw allow <span class=\"token number\">465</span>/tcp <span class=\"token comment\"># SMTPS</span>\r\nufw allow <span class=\"token number\">587</span>/tcp <span class=\"token comment\"># Submission</span>\r\nufw allow <span class=\"token number\">993</span>/tcp <span class=\"token comment\"># IMAPS</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span> ufw status <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-q</span> <span class=\"token string\">\"Status: active\"</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    ufw <span class=\"token builtin class-name\">enable</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Creating user noreply@<span class=\"token variable\">${DOMAIN}</span>...\"</span>\r\n<span class=\"token comment\">#doveadm user add noreply@${DOMAIN} Kode1234!</span>\r\ndoveadm user <span class=\"token function\">add</span> noreply\r\n\r\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /home/noreply/Maildir/<span class=\"token punctuation\">{</span>cur,new,tmp<span class=\"token punctuation\">}</span>\r\n<span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> noreply:noreply /home/noreply/Maildir\r\n\r\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /var/mail/noreply\r\n<span class=\"token function\">chown</span> noreply:noreply /var/mail/noreply\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"mail_location = maildir:/var/mail/noreply\"</span> <span class=\"token operator\">>></span> /etc/dovecot/conf.d/10-mail.conf\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Mail server setup completed successfully!\"</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"This is a test email.\"</span> <span class=\"token operator\">|</span> mail <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"Test Email Subject\"</span> noreply@<span class=\"token variable\">${DOMAIN}</span>\r\n<span class=\"token function\">less</span> /var/mail/noreply\r\n<span class=\"token comment\"># postmap /etc/postfix/relay_domains</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Reloading Postfix and Dovecot...\"</span>\r\nsystemctl reload postfix\r\nsystemctl reload dovecot</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","tableOfContents":"<ul>\n<li><a href=\"#the-script\">The Script</a></li>\n</ul>","frontmatter":{"slug":"create-a-postfix-mail-server","date":"November 06, 2024","title":"Let's Configure a Postfix Mailserver","description":"This script takes you through the most critical steps in setting up a basic postfix mailserver for a custom domain.","categories":["bash"],"tags":["bash","postfix"],"featured":true,"series":""}}},"pageContext":{"id":"9b789c9a-841c-5e7d-8a28-80b9cb0442ae","frontmatter__slug":"create-a-postfix-mail-server","__params":{"frontmatter__slug":"create-a-postfix-mail-server"}}},"staticQueryHashes":["333350632"],"slicesMap":{}}